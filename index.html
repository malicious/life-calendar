<!DOCTYPE html>
<html lang=en">

<head>
    <meta charset="utf-8" />
    <!-- https://waitbutwhy.com/2014/05/life-weeks.html -->
    <title>Life in Weeks</title>
    <style>
        body {
            font-family: 'Helvetica Neue', 'FrutigerLTStd-UltraBlack', 'Myriad Pro Light', sans-serif;
            font-weight: 200;
            -webkit-user-select: none;
        }

        .empty-box {
            stroke: #eee;
            stroke-width: 1px;
            fill: transparent;
        }

        .filled-box {
            stroke: #777;
            stroke-width: 2px;
            fill: transparent;
        }

        g.box:hover>rect {
            fill: #db3d2a;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: black;
            }

            text {
                fill: silver;
            }

            .empty-box {
                stroke: #555;
            }

            .filled-box {
                stroke: #bbb;
                fill: transparent;
            }
        }
    </style>
</head>

<body>
    <svg id="week-calendar" width="960px" height="320px" xmlns="http://www.w3.org/2000/svg">
        <rect x="0" y="0" width="100%" height="100%" style="fill: silver"></rect>
        <text x="100" y="160">Enable JavaScript to render table</text>
    </svg>

    <script type="text/javascript">
        WEEKBOX_WIDTH = 18;
        WEEKBOX_HEIGHT = 18;
        CALENDAR_MARGIN_LEFT = 250;
        CALENDAR_MARGIN_TOP = 36;

        DRAW_DATE_REFERENCE = new Date();


        /*
         * Instead of pulling in moment.js, do our own calculation.
         * Relies on the fact that ISO 8601 week number for 28-Dec gives number of weeks that we want.
         *
         * https://stackoverflow.com/a/74906375/2631462
         */
        function weeksIn(year) {
            const magic_dec28 = new Date(Date.UTC(year, 11, 28));
            const week_day_offset = magic_dec28.getUTCDay() || 7; // sunday needs to be a 7 for math
            const idk_new = new Date(magic_dec28.setUTCDate(magic_dec28.getUTCDate() + 4 - week_day_offset));

            const year_start = new Date(Date.UTC(idk_new.getUTCFullYear(), 0, 1)).getTime();
            weeks = Math.ceil(((idk_new.getTime() - year_start) / 86_400_000 + 1) / 7);
            // console.log(`Year ${year} has ${weeks} weeks`);
            return weeks;
        }

        /*
         * Linear interpolation of actuarial data from
         * https://www.ssa.gov/oact/STATS/table4c6.html
         */
        function yearsExpected(birth_date, current_date) {
            expectancy_table = {
                 0: 74.12,
                10: 64.67,
                20: 54.97,
                30: 45.86,
                35: 41.39,
                36: 40.50,
                37: 39.62,
                50: 28.33,
                60: 20.47,
                70: 13.59,
                80:  7.74,
                90:  3.72,
                99:  2.04,
            }

            let msec_per_day = 24 * 60 * 60 * 1000;
            years_delta = (current_date - birth_date) / msec_per_day / 365.24;

            less_entry = Object.keys(expectancy_table).filter(elem => elem <  years_delta).at(-1);
            next_entry = Object.keys(expectancy_table).filter(elem => elem >= years_delta)[0];
            console.log(`Interpolating life expectancy between ${less_entry} and ${next_entry}`);

            entry_distance = next_entry - less_entry
            time_left =
                expectancy_table[less_entry] * (years_delta - less_entry) / entry_distance +
                expectancy_table[next_entry] * (next_entry - years_delta) / entry_distance;

            console.log(`Estimating that ${years_delta.toFixed(3)} years of age => ${time_left.toFixed(3)}`);
            return years_delta + time_left;
        }


        class weekBox {
            constructor(calendar_start_date, year_offset, week_offset) {
                this.calendar_start_date = calendar_start_date;
                this.year_offset = year_offset;
                this.week_offset = week_offset;
            }

            get fractional_years() {
                return this.year_offset + this.week_offset / weeksIn(start_date.getFullYear() + this.year_offset);
            }

            get start_date() {
                start_date = new Date(this.calendar_start_date);
                start_date.setFullYear(start_date.getFullYear() + this.year_offset);
                start_date.setDate(start_date.getDate() + this.week_offset * 7);

                return start_date;
            }

            // TODO: Move this to CSS classes for maybe-better performance
            lookupColor() {
                if (this.fractional_years < 5.5) // early years
                    return "rgba(173, 216, 230, 0.5)";
                if (this.fractional_years < 11.5) // elementary school
                    return "rgba(0, 128, 0, 0.5)";
                if (this.fractional_years < 14.5) // middle school
                    return "rgba(255, 255, 0, 0.5)";
                if (this.fractional_years < 18.5) // high school
                    return "rgba(255, 165, 0, 0.5)";
                if (this.fractional_years < 22.5) // college
                    return "rgba(255, 192, 203, 0.5)";
                if (this.fractional_years < 62) // career
                    return "rgba(0, 128, 128, 0.4)";

                return "transparent";
            }

            lookupBoxClass() {
                if (this.start_date < DRAW_DATE_REFERENCE)
                    return "filled-box";
                else
                    return "empty-box";
            }

            /**
             * Render the box + its background, taking margins into consideration.
             * 
             * Box interior is 10x10 pixels, with 1x1 border and 6 pixels on each side
             */
            renderNodes(margin_x, margin_y) {
                let box_group = document.createElementNS('http://www.w3.org/2000/svg', 'g');

                let bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bg.setAttribute('x', this.week_offset * WEEKBOX_WIDTH + margin_x);
                bg.setAttribute('y', this.year_offset * WEEKBOX_HEIGHT + margin_y);
                bg.setAttribute('width', WEEKBOX_WIDTH);
                bg.setAttribute('height', WEEKBOX_HEIGHT);
                bg.setAttribute('stroke-width', "0");
                bg.setAttribute('fill', this.lookupColor());
                box_group.appendChild(bg);

                let box = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                box.setAttribute('x', this.week_offset * WEEKBOX_WIDTH + margin_x + 4);
                box.setAttribute('y', this.year_offset * WEEKBOX_HEIGHT + margin_y + 4);
                box.setAttribute('width', "10");
                box.setAttribute('height', "10");
                box.classList.add(this.lookupBoxClass());
                box_group.appendChild(box);

                let tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                tooltip.innerHTML = `Box ${this.start_date.toLocaleDateString()}:\n\n` +
                    `Year: ${this.year_offset}\n` +
                    `Week: ${this.week_offset}`;
                box_group.appendChild(tooltip);

                return box_group;
            }
        }


        /**
         * @param years Number of year-rows to draw. Explicitly supports floats.
         * @param start_date Start date for year 0. Used to draw leap years, among other things.
         */
        function drawGrid(svg_parent, years, start_date) {
            for (let y = 0; y < Math.floor(years); y++) {
                weeks_this_year = weeksIn(start_date.getFullYear() + y);

                let year_group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                year_group.classList.add("row");
                year_group.id = `year-${y}`;
                svg_parent.appendChild(year_group);

                for (let week = 0; week < weeks_this_year; week++) {
                    box = new weekBox(start_date, y, week);

                    box_group = box.renderNodes(CALENDAR_MARGIN_LEFT, CALENDAR_MARGIN_TOP);
                    box_group.classList.add("box");
                    box_group.id = `week-${y}-${week}`;
                    year_group.appendChild(box_group);
                }
            }

            final_year = Math.floor(years);
            extra_weeks = (years - final_year) * 52;

            let year_group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            year_group.classList.add("row");
            year_group.id = `year-${final_year}`;
            svg_parent.appendChild(year_group);

            for (let week = 0; week < extra_weeks; week++) {
                box = new weekBox(start_date, final_year, week);

                box_group = box.renderNodes(CALENDAR_MARGIN_LEFT, CALENDAR_MARGIN_TOP);
                box_group.classList.add("box");
                box_group.id = `week-${final_year}-${week}`;
                year_group.appendChild(box_group);
            }

            s.setAttribute('width', CALENDAR_MARGIN_LEFT + 53 * 18);
            s.setAttribute('height', CALENDAR_MARGIN_TOP + Math.ceil(years) * 18);
        }


        function drawAxisLabels(svg_parent) {
            function make_label(x_pos, y_pos, text) {
                let label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x_pos);
                label.setAttribute('y', y_pos);
                label.innerHTML = text;

                svg_parent.appendChild(label);
            }

            for (let week = 5; week < 52; week += 5) {
                let week_label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                week_label.setAttribute('x', (week - 1) * WEEKBOX_WIDTH + CALENDAR_MARGIN_LEFT);
                week_label.setAttribute('y', CALENDAR_MARGIN_TOP - 8);
                week_label.innerHTML = `${week}`;

                svg_parent.appendChild(week_label);
            }

            for (let year = 5; year < 200; year += 5) {
                make_label(
                    CALENDAR_MARGIN_LEFT - 48,
                    year * WEEKBOX_HEIGHT + CALENDAR_MARGIN_TOP + WEEKBOX_HEIGHT,
                    `${year} yo`);
            }
        }


        /*
         * Really, what we want is an old-style HTML table.
         * Instead, do a lot of work to recreate something similar.
         *
         * We remove + create a new SVG element because... that's what Safari wants, sometimes.
         */
        var s0 = document.getElementById("week-calendar");
        s0.remove();

        start_date = new Date(Date.UTC(2000, 7, 22));
        years_expected = yearsExpected(start_date, DRAW_DATE_REFERENCE);

        let s = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        s.setAttribute("id", "week-calendar");
        s.setAttribute("width", CALENDAR_MARGIN_LEFT + 53 * WEEKBOX_WIDTH);
        s.setAttribute("height", CALENDAR_MARGIN_TOP + (years_expected+2) * WEEKBOX_HEIGHT);

        drawGrid(s, years_expected, start_date);
        drawAxisLabels(s);

        document.body.appendChild(s);

    </script>
</body>

</html>